# Contributing to Lab Intelligence Framework

Thank you for your interest in contributing! This document provides guidelines for contributing to the project.

## Table of Contents

- [Code of Conduct](#code-of-conduct)
- [Getting Started](#getting-started)
- [Development Setup](#development-setup)
- [Data Sensitivity](#data-sensitivity)
- [Code Style](#code-style)
- [Making Changes](#making-changes)
- [Testing](#testing)
- [Pull Request Process](#pull-request-process)

## Code of Conduct

- Be respectful and inclusive
- Focus on constructive feedback
- Prioritize patient data privacy in all discussions
- Help others learn and grow

## Getting Started

### Prerequisites

- R >= 4.3.0
- Quarto >= 1.4.0
- Git
- Make (optional but recommended)

### Fork and Clone

```bash
# Fork the repository on GitHub, then clone your fork
git clone https://github.com/YOUR_USERNAME/agentskills.git
cd agentskills

# Add upstream remote
git remote add upstream https://github.com/marcmtk/agentskills.git
```

## Development Setup

### Install R Dependencies

```r
# Core packages
install.packages(c(
  "dplyr", "tidyr", "purrr",
  "ggplot2", "scales",
  "lubridate", "gt"
))

# Development packages
install.packages(c(
  "testthat",   # Testing
  "lintr",      # Linting
  "styler",     # Code formatting
  "renv"        # Dependency management
))

# Production synthetic data
install.packages("synthpop")
```

### Using renv (Recommended)

```r
# Restore exact package versions
renv::restore()
```

### Verify Setup

```bash
# Generate data and run tests
make data
make test
```

## Data Sensitivity

**CRITICAL**: This project handles healthcare data concepts. Follow these rules:

### Never Commit

- Real patient data (any layer 1 or 2 data)
- Database credentials or connection strings
- API keys or tokens
- Any personally identifiable information (PII)
- Any protected health information (PHI)

### Safe to Commit

- Synthetic data generated by `generate_all_data.R`
- Code that processes data
- Documentation
- Test fixtures using synthetic data

### Data Layer Reference

| Layer | What It Contains | Can Commit? |
|-------|------------------|-------------|
| Layer 1 | Production patient data | NEVER |
| Layer 2 | Analytics (aggregated) | NEVER |
| Layer 3 | Synthetic data | Yes |
| Layer 4 | Development code | Yes |

If unsure, **ask before committing**.

## Code Style

### R Code

Follow the tidyverse style guide with these specifics:

#### Use Native Pipe

```r
# Good
data |>
  filter(x > 0) |>
  mutate(y = x * 2)

# Avoid
data %>%
  filter(x > 0) %>%
  mutate(y = x * 2)
```

#### Use Modern Join Syntax

```r
# Good
left_join(df1, df2, by = join_by(id))
left_join(df1, df2, by = join_by(a == b))

# Avoid
left_join(df1, df2, by = "id")
left_join(df1, df2, by = c("a" = "b"))
```

#### Use .by for Grouping

```r
# Good
data |>
  summarise(mean_x = mean(x), .by = group)

# Avoid (unless you need persistent groups)
data |>
  group_by(group) |>
  summarise(mean_x = mean(x)) |>
  ungroup()
```

#### Naming Conventions

- Variables: `snake_case` (nouns)
- Functions: `snake_case` (verbs)
- Constants: `SCREAMING_SNAKE_CASE`
- Files: `lowercase-with-hyphens.R`

### Quarto Documents

- Use YAML front matter for metadata
- Include `code-fold: true` for complex code
- Add meaningful chunk labels
- Include alt text for figures

### Run Linting

```bash
make lint

# Or in R
lintr::lint_dir("reports/")
```

## Making Changes

### Branch Naming

```
feature/add-new-dashboard
bugfix/fix-qc-calculation
docs/update-readme
refactor/consolidate-generators
```

### Commit Messages

Follow conventional commits:

```
type(scope): description

[optional body]

[optional footer]
```

Types:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation only
- `style`: Formatting, no code change
- `refactor`: Code change, no new feature
- `test`: Adding tests
- `chore`: Maintenance tasks

Examples:
```
feat(reports): add specimen rejection rate chart
fix(qc-trending): correct z-score calculation
docs(readme): add Docker instructions
test(generators): add validation tests for activity volume
```

### Keep Changes Focused

- One feature/fix per PR
- Keep PRs under 500 lines when possible
- Split large changes into logical commits

## Testing

### Test Structure

```
tests/
├── testthat.R           # Test runner
└── testthat/
    ├── test-data-generators.R
    ├── test-data-validation.R
    └── test-report-render.R
```

### Running Tests

```bash
# All tests
make test

# Specific file
Rscript -e "testthat::test_file('tests/testthat/test-data-generators.R')"
```

### Writing Tests

```r
test_that("activity volume has required columns", {
  data <- generate_activity_volume()

  expect_true("daily" %in% names(data))
  expect_true("weekly" %in% names(data))

  daily <- data$daily
  expect_true(all(c("date", "section", "test_count") %in% names(daily)))
})

test_that("test counts are non-negative", {
  data <- generate_activity_volume()

  expect_true(all(data$daily$test_count >= 0))
  expect_true(all(data$weekly$test_count >= 0))
})
```

### Test Coverage Goals

- Data generators: Validate output structure and ranges
- Validation functions: Test edge cases
- Report rendering: Verify reports compile without error

## Pull Request Process

### Before Submitting

1. **Sync with upstream**
   ```bash
   git fetch upstream
   git rebase upstream/main
   ```

2. **Run all checks**
   ```bash
   make test
   make lint
   ```

3. **Update documentation** if needed

4. **Add/update tests** for new functionality

### PR Template

```markdown
## Description
Brief description of changes

## Type of Change
- [ ] Bug fix
- [ ] New feature
- [ ] Documentation
- [ ] Refactoring

## Testing
- [ ] Tests pass locally
- [ ] New tests added (if applicable)
- [ ] Linting passes

## Data Sensitivity
- [ ] No real patient data included
- [ ] No credentials or secrets included

## Screenshots (if applicable)
```

### Review Process

1. Automated CI checks must pass
2. At least one maintainer review required
3. All comments must be resolved
4. Squash merge preferred for clean history

### After Merge

- Delete your feature branch
- Pull latest main
- Celebrate your contribution!

## Questions?

- Open an issue for bugs or feature requests
- Start a discussion for questions
- Check existing issues before creating new ones

## Recognition

Contributors are recognized in:
- GitHub contributors list
- Release notes for significant contributions

Thank you for helping improve lab analytics!
